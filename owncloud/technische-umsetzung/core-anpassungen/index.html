<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="author" content="Lukas Biermann, Nina Herrmann, Wladislaw Iwanzow, Dennis Meis, Jonathan Neugebauer">  
    <link rel="shortcut icon" href="../../../img/favicon.ico">

    <title>Core Anpassungen - sciebo@Learnweb</title>

    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../../css/base.css" rel="stylesheet">
    <link href="../../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../..">sciebo@Learnweb</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">ownCloud <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Technische Umsetzung</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../oauth2/">OAuth 2.0</a>
</li>

        
            
<li >
    <a href="../softwarearchitektur/">Softwarearchitektur</a>
</li>

        
            
<li >
    <a href="../oauth2-app/">OAuth 2.0 App</a>
</li>

        
            
<li class="active">
    <a href="./">Core Anpassungen</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../benutzung/">Benutzung</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Moodle <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Technische Umsetzung</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../moodle/technische-umsetzung/softwarearchitektur/">Softwarearchitektur</a>
</li>

        
            
<li >
    <a href="../../../moodle/technische-umsetzung/admin-tool/">Admin Tool</a>
</li>

        
            
<li >
    <a href="../../../moodle/technische-umsetzung/repository/">Repository</a>
</li>

        
            
<li >
    <a href="../../../moodle/technische-umsetzung/activity/">Collaborative Folders</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../../moodle/benutzung/">Benutzung</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Suchen
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../oauth2-app/">
                            <i class="fa fa-arrow-left"></i> Zurück
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../benutzung/">
                            Weiter <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/pssl16">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="first-level active"><a href="#core-anpassungen">Core Anpassungen</a></li>
        
            <li class="second-level"><a href="#zweck">Zweck</a></li>
            
        
            <li class="second-level"><a href="#vorgegebene-schnittstelle">Vorgegebene Schnittstelle</a></li>
            
                <li class="third-level"><a href="#webdav">WebDAV</a></li>
            
                <li class="third-level"><a href="#owncloud-apis">ownCloud APIs</a></li>
            
        
            <li class="second-level"><a href="#implementierung">Implementierung</a></li>
            
                <li class="third-level"><a href="#webdav_1">WebDAV</a></li>
            
                <li class="third-level"><a href="#owncloud-apis_1">ownCloud APIs</a></li>
            
        
            <li class="second-level"><a href="#tests-und-continuous-integration">Tests und Continuous Integration</a></li>
            
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="core-anpassungen">Core Anpassungen</h1>
<h2 id="zweck">Zweck</h2>
<p>Um das durch die <code>oauth2</code> App implementierte OAuth 2.0 Protokoll für den Zugriff auf die <a href="https://doc.owncloud.org/server/9.1/user_manual/files/access_webdav.html">WebDAV Schnittstelle</a> und die <a href="https://doc.owncloud.org/server/9.1/developer_manual/core/ocs-share-api.html">OCS Share API</a> nutzen zu können, mussten Anpassungen am <a href="https://github.com/owncloud/core">ownCloud Core</a> durchgeführt werden. Diese Änderungen liegen im Pull Request <a href="https://github.com/owncloud/core/pull/26742">owncloud/core#26742</a> vor. Ein Backport für ownCloud 9.1 ist im Pull Request <a href="https://github.com/owncloud/core/pull/27370">owncloud/core#27370</a> zu finden.</p>
<h2 id="vorgegebene-schnittstelle">Vorgegebene Schnittstelle</h2>
<p>Bevor wir ownCloud um OAuth 2.0 erweitern konnten, mussten wir die vorgegebene Schnittstelle untersuchen. Dazu schauten wir uns die Implementierungen von WebDAV und der OCS Share API an.</p>
<h3 id="webdav">WebDAV</h3>
<p>Bei der Untersuchung der WebDAV Schnittstelle stellte sich heraus, dass hierfür eine ownCloud App namens <code>dav</code> verwendet wurde, die die <a href="http://sabre.io">sabre/dav</a> Bibliothek zur Implementierung des WebDAV-Serves nutzt. Da die Bibliothek den Austausch der Authentifizierung über eigene Authentication Backends unterstützt, entschieden wir uns dafür, diesen Mechanismus auch für die Bereitstellung von OAuth 2.0 zu nutzen. Die Implementierung eines solchen Backends wird auf der Seite zur <a href="../oauth2-app/#authentifizierungslogik">OAuth 2.0 App</a> beschrieben.</p>
<h3 id="owncloud-apis">ownCloud APIs</h3>
<p>Die Implementierung der OCS Share API wird größtenteils durch die ownCloud App <code>files_sharing</code> bereitgestellt. Daher mussten Änderungen auf Ebene von ownCloud Apps und im Speziellen bei der Authentifizierung der von ihnen definierten APIs durchgeführt werden. Wir folgten dem Vorschlag eines ownCloud Entwicklers, dafür einen Plugin Mechanismus zu implementieren, sodass Apps weitere Authentifizierungsmethoden bereitstellen können.</p>
<h2 id="implementierung">Implementierung</h2>
<h3 id="webdav_1">WebDAV</h3>
<p>Um eigene Authentication Backends für die <code>dav</code> App bekannt zu machen und gleichzeitig keine Abhängigkeit zu schaffen, nutzten wir Event Listener. Vor dem Start des WebDAV-Servers in der Datei <code>appinfo/v1/webdav.php</code> lösten wir das <code>authInit</code>-Event aus, wie folgendes Codebeispiel zeigt.</p>
<pre><code class="php">&lt;?php
$event = new \OCP\SabrePluginEvent($server);
\OC::$server-&gt;getEventDispatcher()-&gt;dispatch('OCA\DAV\Connector\Sabre::authInit', $event);
</code></pre>

<p>Dadurch ist es ownCloud Apps möglich, das Event abzugreifen und vor dem Start des WebDAV-Servers weitere Authentication Backends hinzuzufügen. Wie dies in der OAuth 2.0 App implementiert wurde, beschreibt <a href="../oauth2-app/#authentifizierungslogik">dessen Seite</a>.</p>
<h3 id="owncloud-apis_1">ownCloud APIs</h3>
<p>Die Authentifizierung von API-Zugriffen in ownCloud geschieht in der Datei <code>lib/private/legacy/api.php</code>, welche auf <code>lib/private/User/Session.php</code> zurückgreift. Analog zu den bestehenden Funktionen <code>tryTokenLogin</code> und <code>tryBasicAuthLogin</code> fügten wir die Funktion <code>tryAuthModuleLogin</code> hinzu. Ein <code>AuthModule</code> kann dabei von ownCloud Apps bereitgestellt werden, indem eine Implementierung des Interfaces <code>IAuthModule</code> (zu finden in der Datei <code>lib/public/Authentication/IAuthModule.php</code>) registriert wird. Nachfolgendes Codebeispiel zeigt dieses Interface.</p>
<pre><code class="php">&lt;?php
namespace OCP\Authentication;

use OCP\IRequest;
use OCP\IUser;

/**
 * Interface IAuthModule
 *
 * @package OCP\Authentication
 * @since 10.0.0
 */
interface IAuthModule {

    /**
     * Authenticates a request.
     *
     * @param IRequest $request The request.
     *
     * @return null|IUser The user if the request is authenticated, null otherwise.
     * @since 10.0.0
     */
    public function auth(IRequest $request);

    /**
     * Returns the user's password.
     *
     * @param IRequest $request The request.
     *
     * @return String The user's password.
     * @since 10.0.0
     */
    public function getUserPassword(IRequest $request);

}
</code></pre>

<p>Die Funktion <code>auth</code> authentifiziert eine Anfrage und ermittelt (bei erfolgreicher Authentifizierung) den zugehörigen Nutzer. Zusätzlich gibt es noch die Funktion <code>getUserPassword</code>, welche zu einer Anfrage das Passwort des Nutzers bestimmt. Sie wurde hinzugefügt, da die App <code>encryption</code> in bestimmten Nutzungsszenarien auf das Passwort des Nutzers angewiesen ist.</p>
<p>In der Funktion <code>tryAuthModuleLogin</code> der Klasse <code>Session</code> werden nun alle von ownCloud Apps bereitgestellten Implementierungen von <code>IAuthModule</code> geladen und zur Authentifizierung genutzt, wie im folgenden Codebeispiel zu sehen.</p>
<pre><code class="php">&lt;?php
/**
 * Tries to login with an AuthModule provided by an app
 *
 * @param IRequest $request The request
 * @return bool True if request can be authenticated, false otherwise
 * @throws Exception If the auth module could not be loaded
 */
public function tryAuthModuleLogin(IRequest $request) {
    /** @var IAppManager $appManager */
    $appManager = OC::$server-&gt;query('AppManager');
    $allApps = $appManager-&gt;getInstalledApps();

    foreach ($allApps as $appId) {
        $info = $appManager-&gt;getAppInfo($appId);

        if (isset($info['auth-modules'])) {
            $authModules = $info['auth-modules'];

            foreach ($authModules as $class) {
                try {
                    if (!OC_App::isAppLoaded($appId)) {
                        OC_App::loadApp($appId);
                    }

                    /** @var IAuthModule $authModule */
                    $authModule = OC::$server-&gt;query($class);

                    if ($authModule instanceof IAuthModule) {
                        return $this-&gt;loginUser(
                            $authModule-&gt;auth($request),
                            $authModule-&gt;getUserPassword($request)
                        );
                    } else {
                        throw new Exception(&quot;Could not load the auth module $class&quot;);
                    }
                } catch (QueryException $exc) {
                    throw new Exception(&quot;Could not load the auth module $class&quot;);
                }
            }
        }
    }

    return false;
}
</code></pre>

<p>Hier wird in allen installierten Apps in der <code>info.xml</code> nach dem Tag <code>auth-modules</code> gesucht. Durch Nutzung von Registrierungen in der <code>info.xml</code> war es möglich, Abhängigkeiten zu anderen Apps zu vermeiden. Falls die App ein <code>AuthModule</code> implementiert und registriert hat, wird die registrierte Klasse geladen und für die Funktion <code>loginUser</code> genutzt.</p>
<p>Die Funktion <code>loginUser</code> ist analog zu der bestehenden Funktion <code>loginWithToken</code> implementiert worden und nutzt die Rückgabewerte der beiden Funktionen aus dem <code>AuthModule</code>, wie folgendes Codebeispiel zeigt.</p>
<pre><code class="php">/**
 * Logs a user in
 *
 * @param IUser $user The user
 * @param String $password The user's password
 * @return boolean True if the user can be authenticated, false otherwise
 * @throws LoginException if an app canceled the login process or the user is not enabled
 */
private function loginUser($user, $password) {
    if (is_null($user)) {
        return false;
    }

    $this-&gt;manager-&gt;emit('\OC\User', 'preLogin', [$user, $password]);

    if (!$user-&gt;isEnabled()) {
        $message = \OC::$server-&gt;getL10N('lib')-&gt;t('User disabled');
        throw new LoginException($message);
    }

    $this-&gt;setUser($user);
    $this-&gt;setLoginName($user-&gt;getDisplayName());

    $this-&gt;manager-&gt;emit('\OC\User', 'postLogin', [$user, $password]);

    if ($this-&gt;isLoggedIn()) {
        $this-&gt;prepareUserLogin(false);
    } else {
        $message = \OC::$server-&gt;getL10N('lib')-&gt;t('Login canceled by app');
        throw new LoginException($message);
    }

    return true;
}
</code></pre>

<p>Die Implementierung und Registrierung eines <code>AuthModule</code>s in der OAuth 2.0 App wird auf <a href="../oauth2-app/#authentifizierungslogik">dessen Seite</a> beschrieben.</p>
<h2 id="tests-und-continuous-integration">Tests und Continuous Integration</h2>
<p>Die Änderungen in den Pull Requests durchliefen die Tests zum ownCloud Core, die bei <a href="https://jenkins.owncloud.org/job/owncloud-core/job/core/">Jenkins</a> und <a href="https://travis-ci.org/owncloud/core/">Travis</a> ausgeführt wurden.</p></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Copyright &copy; 2017 PSSL16<br></small>
        
        <small>Dokumentation erzeugt mit <a href="http://www.mkdocs.org/">MkDocs</a>.</small></p>
    </footer>

    <script src="../../../js/jquery-1.10.2.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../../..';
    </script>
    <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
    <script src="../../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Schließen</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Suchen</h4>
                </div>
                <div class="modal-body">
                    <p>
                        Hier können Sie die Dokumentation durchsuchen. Geben Sie Ihre Suchbegriffe unten ein.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Suchen..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
