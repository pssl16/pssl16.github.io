<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <meta name="author" content="Lukas Biermann, Nina Herrmann, Wladislaw Iwanzow, Dennis Meis, Jonathan Neugebauer">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Admin Tool - sciebo@Learnweb</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">sciebo@Learnweb</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">ownCloud <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../owncloud/technische-umsetzung/">Technische Umsetzung</a>
</li>

                        
                            
<li >
    <a href="../../owncloud/benutzung/">Benutzung</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Moodle <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Technische Umsetzung</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../software-architektur/">Software Architektur</a>
</li>

        
            
<li class="active">
    <a href="./">Admin Tool</a>
</li>

        
            
<li >
    <a href="../repository/">Repository</a>
</li>

        
            
<li >
    <a href="../activity/">Collaborative Folders</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../benutzung/">Benutzung</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Suchen
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../software-architektur/">
                            <i class="fa fa-arrow-left"></i> Zurück
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../repository/">
                            Weiter <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/pssl16">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="first-level active"><a href="#admin-tool-oauth2sciebo">Admin Tool: oauth2sciebo</a></li>
        
            <li class="second-level"><a href="#zweck-des-plugins">Zweck des Plugins</a></li>
            
        
            <li class="second-level"><a href="#vorgegebene-schnittstelle">Vorgegebene Schnittstelle</a></li>
            
        
            <li class="second-level"><a href="#implementierung-der-vorgegebenen-schnittstelle">Implementierung der vorgegebenen Schnittstelle</a></li>
            
                <li class="third-level"><a href="#eingabemaske">Eingabemaske</a></li>
            
                <li class="third-level"><a href="#oauth-20-client">OAuth 2.0 Client</a></li>
            
        
            <li class="second-level"><a href="#tests-und-ci">Tests und CI</a></li>
            
        
    
        <li class="first-level "><a href="#anderungen-an-core-bibliotheken">Änderungen an Core Bibliotheken</a></li>
        
            <li class="second-level"><a href="#anpassung-des-webdav-clients">Anpassung des WebDAV Clients</a></li>
            
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="admin-tool-oauth2sciebo">Admin Tool: <code>oauth2sciebo</code></h1>
<h2 id="zweck-des-plugins">Zweck des Plugins</h2>
<p>Wie bereits im Kapitel <a href="../software-architektur/">Software Architektur</a> angeschnitten, ist der Hauptzweck dieses Plugins
die Schnittstelle zu Sciebo bzw. ownCloud bereitzustellen. Zu diesem Zweck wird die im Projekt implementierte ownCloud 
App <a href="../../owncloud/technische-umsetzung/">OAuth2</a> mit Hilfe eines OAuth 2.0 Clients über die WebDAV Schnittstelle angesprochen.
Gleichzeitig kann dieses Plugin auch für ähnliche externe Datenquellen verwendet werden, sofern diese über die nötigen
OAuth 2.0 und WebDAV Schnittstellen verfügen.</p>
<p>Im Wesentlichen implementiert dieses Plugin folgende <a href="../software-architektur/">Integrationsszenarien</a>:</p>
<ul>
<li><strong>Beispiel 1:</strong> ...</li>
<li><strong>Beispiel 2:</strong> ...</li>
</ul>
<div class="alert alert-danger">
  <strong>TODO:</strong> Integrationsszenarien definieren und hier einfügen.
</div>

<h2 id="vorgegebene-schnittstelle">Vorgegebene Schnittstelle</h2>
<p>Für Admin Tools ist in moodle lediglich eine schwach definierte Schnittstelle gegeben. Wie in jedem anderen moodle Plugin 
auch, müssen zunächst einige Standartdateien implementiert werden: </p>
<ul>
<li><strong><code>version.php</code>:</strong> Beschreibt die Versionsnummer des Plugins, die benötigte moodle Version und Abhängigkeiten des Plugins.</li>
<li><strong><code>access.php</code>:</strong> Legt die Berechtigungen für definierte Aktionen innerhalb des Plugins anhand von Nutzerrollen fest.</li>
<li><strong><code>tool_oauth2sciebo.php</code>:</strong> Beinhaltet Sprachstrings für unterschiedliche Regionen und Sprachen, sodass definierte Strings,
abhängig von der jeweiligen Sprache, dynamisch angezeigt werden können.</li>
</ul>
<p>Zusätzlich zu den allgemeinen Plugindateien, sollte unser Admin Tool auch mindestens noch eine Datei namens <code>settings.php</code>
beinhalten. Diese umfasst alle Einstellungen, die für das Admin Tool geltend dem Administrator der moodle Instanz zur 
Verfügung gestellt werden sollen. Nach der Eingabe, wird diese Konfiguration moodle-intern in dem sogenannten <a href="https://docs.moodle.org/dev/Admin_settings">Admin Tree</a>
gespeichert. Aus dieser Baumstruktur können anschließend benötigte Einstellungen beschafft werden.</p>
<p>Insgesamt ergibt sich folgende Struktur von Ordnern und Dateien, die mindestens für die Implementierung des von uns gebrauchten
Admin Tools notwendig ist:</p>
<div class="alert alert-danger">
  <strong>TODO:</strong> Grafik für Ordnerstruktur einfügen.
</div>

<h2 id="implementierung-der-vorgegebenen-schnittstelle">Implementierung der vorgegebenen Schnittstelle</h2>
<h3 id="eingabemaske">Eingabemaske</h3>
<h4 id="benotigte-eingaben">Benötigte Eingaben</h4>
<p>Um die OAuth 2.0 und WebDAV Clients erfolgreich zum Zugriff auf eine entsprechende Sciebo bzw. ownCloud Instanz zu befähigen,
müssen diese zunächst mit Hilfe benötigter Eingabedaten konfiguriert werden. Diese sollen zentral im Admin Tool eingegeben und
gespeichert werden können, um sie anschließend von anderen Plugins aus nutzen zu können. Zu diesem Zweck werden globale Optionen
werden, welche instanzübergreifend gelten.</p>
<p>Um den OAuth 2.0 Protokollablauf zu ermöglichen, müssen folgende Daten im Vorfeld erfasst werden:</p>
<ul>
<li><strong><code>Client ID</code>:</strong> wird in ownCloud generiert und dient der Identifizierung eines regstrierten Clients.</li>
<li><strong><code>Secret</code>:</strong> wird ebenfalls in ownCloud generiert und zur Authentifizierung verwendet.</li>
</ul>
<p>Beide Datensätze sind Strings bestehend aus Buchstaben und Zahlen. Daher eignet sich für beide ein Textfeld, welches ausschließlich 
alphanumerische Werte erwartet zur Eingabe.</p>
<p>Zur Nutzung des WebDAV Clients werden darüber hinaus folgende Daten benötigt:</p>
<ul>
<li><strong><code>Server Addresse</code>:</strong> Url über die der ownCloud Server erreicht werden kann.</li>
<li><strong><code>Server Pfad</code>:</strong> der angehangene Pfad, über den die WebDAV Schnittstelle erreicht werden kann.</li>
<li><strong><code>Port</code>:</strong> Port des WebDAV-Servers.</li>
<li><strong><code>SSL-Verschlüsselung</code>:</strong> Wahl zwischen HTTP und HTTPS. </li>
</ul>
<p>Während die Wahl des Protokolls mittels einer Auswahl aus vorhandenen Optionen abgeboten werden kann, müssen die restlichen Werte
in einem Textfeld erfragt werden. Auch in diesem Fall werden die Variablen nach den zu erwartenden Werten gesäubert. Darüber hinaus
werden alle Eingaben, bis auf dem Port, als notwendig angesehen.</p>
<h4 id="external-page">External Page</h4>
<p>Eine somit notwendige Eingabemaske kann im Rahmen der [<code>settings.php</code>] definiert werden. Da zum Zweck der individuellen Validierung und Säuberung
der benötigten Parameter die in der <a href="https://github.com/moodle/moodle/blob/master/lib/adminlib.php"><code>adminlib.php</code></a> definierten 
Klassen nicht ausreichen, wurde eine <a href="https://docs.moodle.org/dev/Admin_settings#External_pages">externe Seite</a> speziell zur Darstellung
des notwendigen Formulars erstellt. Die externe Seite, welche über die <a href=""><code>index.php</code></a> Datei aufgerufen wird, sorgt dafür, dass
die Einstellungen aus dem Formular global in den <a href="">admin settings</a> gespeichert werden. Von dort aus können sie, sobald nötig ausgelesen
werden. Um die externe Seite nun in die Navigation in der Seitenadministration einzubinden, muss diese in der <code>settings.php</code> in den 
Admin Tree eingebunden werden: </p>
<pre><code class="php">&lt;?php
defined('MOODLE_INTERNAL') || die('moodle_internal not defined');

$ADMIN-&gt;add('authsettings', new admin_externalpage('tool_oauth2sciebo/auth',
        'Sciebo OAuth 2.0 Configuration',
        &quot;$CFG-&gt;wwwroot/$CFG-&gt;admin/tool/oauth2sciebo/index.php&quot;));
</code></pre>

<p>Das <code>admin_externalpage</code> Objekt beschreibt eine externe Seite, die im Admin Tree eingeordnet werden soll. Dazu wird die Seite mit einem
einzigartigen Namen versehen, einem Anzeigenamen und dem Pfad, über den die Seite erreicht werden soll. Neben der externen Seite an
sich, wird bei der Methode <code>add</code> zusätzlich übergeben, an welcher Stelle die Verknüpfung erstellt werden soll. In diesem Fall sind es die
Authentifizierungseinstellungen (<code>authsettings</code>).</p>
<p>Neben der Darstellung des Formulars, verwaltet die externe Seite auch die Speicherung der eigegebenen Daten. Diese werden, ähnlich wie die
externe Seite zuvor, global in den Admin Settings mit Hilfe der Methode <code>set_config()</code> gespeichert. Sobald also das Formular erfolgreich validiert
worden ist, werden die Eingabedaten durch einen Aufruf dieser Methode mit der genauen Bezeichnung der Option und dem Wert, den sie im Fomular
erhalten hat, global abgelegt. Darüber hinaus wird über die externe Seite auch die Rücksetzung der Daten und der Abbruch der Bearbeitung geregelt.
Zuletzt ist die Seite auch dafür zuständig das Formular mit zuvor gesetzten Werten zu füllen, die aus den globalen Einstellungen wiederbeschafft werden.</p>
<h4 id="formular">Formular</h4>
<p>Um ein geeignetes Formular zu definieren musste die moodle-interne Klasse <code>moodleform</code> erweitert und innerhalb der Funktion <code>definition()</code>
alle benötigten Eingabefelder definiert werden. Folgende Funktionen wurden dabei verwedet um die Elemente so genau wie möglich zu umreißen:</p>
<table>
<thead>
<tr>
<th>Funktion</th>
<th>Beschreibung</th>
<th>Beispiel</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>addElement</code></td>
<td>Fügt ein Element zum Formular hinzu</td>
<td>Textfeld, Dropdown Menü, Checkbox</td>
</tr>
<tr>
<td><code>addRule</code></td>
<td>Versieht ein Element mit einer Regel zur Validierung</td>
<td>erforderlich für die Abgabe, nur alphanumerisch</td>
</tr>
<tr>
<td><code>setDefault</code></td>
<td>Setzt den Standartwert für ein Element</td>
<td>-</td>
</tr>
<tr>
<td><code>setType</code></td>
<td>Legt den Parametertypen der Eingabe fest</td>
<td>Integer, String, Pfad, roh</td>
</tr>
</tbody>
</table>
<p>Im Folgenden wird anhand von zwei Beispielen die Anwendung dieser Funktionen dargestellt:</p>
<pre><code class="php">&lt;?php
class tool_oauth2sciebo_client_form extends moodleform {

    public function definition() {
        global $CFG;

        $mform = $this-&gt;_form;
        // Client ID.
        $mform-&gt;addElement('text', 'clientid', get_string('clientid', 'tool_oauth2sciebo'), 
            array('size' =&gt; '64'));
        $mform-&gt;addRule('clientid', get_string('required'), 'required', null, 'client');
        $mform-&gt;addRule('clientid', get_string('err_alphanumeric'), 'alphanumeric', null, 'client');
        $mform-&gt;setDefault('clientid', $this-&gt;_customdata['clientid']);
        $mform-&gt;setType('clientid', PARAM_ALPHANUM);
</code></pre>

<p>Zunächst wird das Client ID Eingabefeld definiert. Hierzu wird zum Formular ein Textfeld hinzugefügt, welches den eindeutigen Namen
<code>clientid</code> trägt und 64 Felder breit ist. Der Anzeigename des Elements wird über ein die Sprachstring-Methode <code>get_string</code> beschafft.
Daraufhin wird das Feld als für die Abgabe benötigt markiert und auf alphanumerische Werte beschränkt. Zuletzt wird der Standartwert
für das Textfeld gesetzt, welcher zuvor durch die externe Seite bei Aufruf übergeben wird und zur Säuberung der Eingabe der Typ des
Elements auf alphanumerisch gestellt.</p>
<pre><code class="php">        // Type of server.
        $mform-&gt;addElement('select', 'type', get_string('type', 'tool_oauth2sciebo'), 
            array('http' =&gt; 'HTTP', 'https' =&gt; 'HTTPS'));
        $mform-&gt;addRule('type', get_string('required'), 'required', null, 'client');
        $mform-&gt;setDefault('type', $this-&gt;_customdata['type']);
    }
}
</code></pre>

<p>Im zweiten Beispiel wird ein <code>select</code> Element zum Formular hinzugefügt. Der Unterschied zum Textfeld ist, dass bei einem Dropdown
Menü auch verfügbare Optionen angegeben werden müssen. Außerdem wird auch dieses Element als benötigt markiert und sein Standartwert
Aus den Aufrufparametern beschafft und gesetzt.</p>
<p>Am Ende des Formulares werden zu guter Letzt noch Buttons zur Abgabe des Formulars definiert. Damit ist die Eingabemaske vollständig. </p>
<h3 id="oauth-20-client">OAuth 2.0 Client</h3>
<p>Den funktionalen Kern des Plugins stellt der OAuth 2.0 Client dar. Dieser befindet sich in Form der Klasse <code>sciebo</code> in der
Datei <code>sciebo.php</code> in dem <code>classes</code> Ordner des Plugins. Diese Klasse steuert sowohl den moodle-seitigen Protokollablauf
von OAuth 2.0, als auch den Verbindungsaufbau zu ownCloud mittels WebDAV. Dadurch, dass <code>sciebo</code> von der im moodle Core
enthaltenen Klasse <code>oauth2_client</code> erbt, ist ein Großteil des Protokollablaufs bereits abgedeckt.
Der Konstruktor der Klasse <code>oauth2_client</code> muss mit den <code>Client ID</code> und <code>Secret</code> Daten aufgerufen werden. 
Diese werden aus den zuvor angewandten Einstellungen beschafft:</p>
<pre><code class="php">&lt;?php

namespace tool_oauth2sciebo;

defined('MOODLE_INTERNAL') || die();

require_once($CFG-&gt;libdir . '/oauthlib.php');

use tool_oauth2sciebo\sciebo_client;

class sciebo extends \oauth2_client {

    /**
     * Create the DropBox API Client.
     *
     * @param   string      $key        The API key
     * @param   string      $secret     The API secret
     * @param   string      $callback   The callback URL
     */
    public function __construct($callback) {
        parent::__construct(get_config('tool_oauth2sciebo', 'clientid'),
            get_config('tool_oauth2sciebo', 'secret'), $callback, '');
</code></pre>

<p>Zu diesem Zweck wird die Methode <code>get_config</code> verwendet. Sie gibt den für ein Plugin und einen zuvor einzigartig definierten
Namen aus dem Admin Tree heraus die dazu gespeicherte Einstellung.
Darüber hinaus muss eine <code>callback URL</code> angefügt werden, die den Pfad angibt, an den nach der Authentifizierung und Autorisierung
weitergeleitet werden soll. Dieser wird allerdings wird extern in den Plugins erzeugt, die die <code>sciebo</code> Klasse benutzen.</p>
<p>Weiterhin müssen die Methoden <code>auth_url</code> und <code>token_url</code> der Elternklasse zwingend überschrieben werden, um bei der Authentifizierung
auf die richtigen Pfade zu verweisen:</p>
<pre><code class="php">    /**
    * Returns the auth url for OAuth 2.0 request
    * @return string the auth url
    */
    protected function auth_url() {
    // Dynamically generated from the admin tool settings.
        $path = str_replace('remote.php/webdav/', '', get_config('tool_oauth2sciebo', 'path'));
        return get_config('tool_oauth2sciebo', 'type') . '://' . get_config('tool_oauth2sciebo', 'server') . '/' . $path
            . 'index.php/apps/oauth2/authorize';
    }

    /**
    * Returns the token url for OAuth 2.0 request
    * @return string the token url
    */
    protected function token_url() {
        $path = str_replace('remote.php/webdav/', '', get_config('tool_oauth2sciebo', 'path'));
        return get_config('tool_oauth2sciebo', 'type') . '://' . get_config('tool_oauth2sciebo', 'server')  . '/' . $path
            . 'index.php/apps/oauth2/api/v1/token';
    }
</code></pre>

<p>Hierfür werden die beiden Pfade aus der Serveraddresse und dem Serverpfad berechnet, da der Endpunkt für die oauth2 App in
ownCloud gleich bleibt.</p>
<div class="alert alert-danger">
  <strong>TODO:</strong> Überschriebene post Methode.
</div>

<h2 id="tests-und-ci">Tests und CI</h2>
<h1 id="anderungen-an-core-bibliotheken">Änderungen an Core Bibliotheken</h1>
<h2 id="anpassung-des-webdav-clients">Anpassung des WebDAV Clients</h2></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Copyright &copy; 2017 PSSL16<br></small>
        
        <small>Dokumentation erzeugt mit <a href="http://www.mkdocs.org/">MkDocs</a>.</small></p>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Schließen</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Suchen</h4>
                </div>
                <div class="modal-body">
                    <p>
                        Hier können Sie die Dokumentation durchsuchen. Geben Sie Ihre Suchbegriffe unten ein.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Suchen..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
